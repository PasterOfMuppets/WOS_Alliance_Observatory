<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foundry Events - WOS Alliance Observatory</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">WOS Alliance Observatory</h1>
            <div class="nav-links">
                <a href="/dashboard">Dashboard</a>
                <a href="/roster">Player Roster</a>
                <a href="/upload">Upload Screenshots</a>
                <a href="#" id="logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2>Foundry Battle Events</h2>

        <div class="events-container">
            <div class="filter-section">
                <label for="legionFilter">Filter by Legion:</label>
                <select id="legionFilter">
                    <option value="all">All Legions</option>
                    <option value="1">Legion 1</option>
                    <option value="2">Legion 2</option>
                </select>
            </div>

            <div id="eventsContainer">
                <p style="text-align: center; padding: 20px;">Loading foundry events...</p>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/';
        }

        document.getElementById('logout').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('access_token');
            window.location.href = '/';
        });

        let allEvents = [];

        async function loadFoundryEvents() {
            try {
                const response = await fetch('/api/events/foundry', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('access_token');
                        window.location.href = '/';
                        return;
                    }
                    throw new Error('Failed to load events');
                }

                const data = await response.json();
                allEvents = data.events;
                renderEvents();
            } catch (error) {
                console.error('Failed to load foundry events:', error);
                document.getElementById('eventsContainer').innerHTML =
                    '<p style="text-align: center; padding: 20px; color: red;">Failed to load events</p>';
            }
        }

        function renderEvents() {
            const legionFilter = document.getElementById('legionFilter').value;
            const filteredEvents = legionFilter === 'all'
                ? allEvents
                : allEvents.filter(e => e.legion_number.toString() === legionFilter);

            const container = document.getElementById('eventsContainer');

            if (filteredEvents.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px;">No foundry events found</p>';
                return;
            }

            container.innerHTML = filteredEvents.map(event => `
                <div class="event-card">
                    <div class="event-header">
                        <h3>Legion ${event.legion_number} - ${new Date(event.event_date).toLocaleDateString()}</h3>
                        <span class="event-stats">
                            ${event.actual_participants}/${event.max_participants} participants
                            ${event.total_troop_power ? `| ${event.total_troop_power.toLocaleString()} power` : ''}
                            ${event.won !== null ? (event.won ? ' | <span style="color: green;">Won</span>' : ' | <span style="color: red;">Lost</span>') : ''}
                        </span>
                    </div>
                    <div class="event-time">
                        Event Date: ${new Date(event.event_date).toLocaleDateString()}
                        ${event.total_score ? `| Total Score: ${event.total_score.toLocaleString()}` : ''}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Signups:</strong> ${event.signups_count} players
                        ${event.results_count > 0 ? `| <strong>Participated:</strong> ${event.results_count} players` : ''}
                        ${event.no_shows_count > 0 ? `| <span style="color: #ff6b6b;"><strong>No-Shows:</strong> ${event.no_shows_count}</span>` : ''}
                    </div>
                    ${event.no_shows_count > 0 ? `
                        <details style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-left: 3px solid #ff6b6b;">
                            <summary style="cursor: pointer; font-weight: bold; color: #856404;">
                                ‚ö†Ô∏è View No-Shows (${event.no_shows_count} player${event.no_shows_count !== 1 ? 's' : ''})
                            </summary>
                            <div id="no-shows-${event.id}" style="margin-top: 10px; padding: 10px;">
                                <p style="font-style: italic; color: #666;">Loading...</p>
                            </div>
                        </details>
                    ` : ''}
                    ${event.top_results && event.top_results.length > 0 ? `
                        <div class="event-scores">
                            <h4>Top 10 Performers (${event.results_count} total)</h4>
                            <table class="scores-table">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Player</th>
                                        <th>Arsenal Points</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${event.top_results.map(score => `
                                        <tr>
                                            <td>${score.rank || '-'}</td>
                                            <td>${score.player_name}</td>
                                            <td>${score.score.toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ${event.results_count > 10 ? `
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer; font-weight: bold; color: #667eea; padding: 10px; background: #f0f0f0; border-radius: 4px;">
                                        üìä View All ${event.results_count} Players
                                    </summary>
                                    <div id="all-results-${event.id}" style="margin-top: 10px;">
                                        <div style="margin-bottom: 10px;">
                                            <label>Filter by Legion: </label>
                                            <select id="legion-filter-${event.id}" onchange="filterResultsByLegion(${event.id}, this.value)">
                                                <option value="">All Legions</option>
                                                <option value="1">Legion 1</option>
                                                <option value="2">Legion 2</option>
                                            </select>
                                        </div>
                                        <div id="all-results-table-${event.id}">
                                            <p style="font-style: italic; color: #666;">Loading...</p>
                                        </div>
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    ` : '<p style="color: #666; font-style: italic;">No results recorded</p>'}
                </div>
            `).join('');

            // Attach event listeners to the new details elements
            attachNoShowsListeners();
        }

        async function loadNoShows(eventId) {
            const container = document.getElementById(`no-shows-${eventId}`);
            if (container.dataset.loaded) {
                return; // Already loaded
            }

            try {
                const response = await fetch(`/api/events/foundry/${eventId}/no-shows`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load no-shows');
                }

                const data = await response.json();

                if (data.no_shows.length === 0) {
                    container.innerHTML = '<p style="color: #666; font-style: italic;">No players missed this event.</p>';
                } else {
                    container.innerHTML = `
                        <p style="margin-bottom: 8px;">
                            ${data.no_shows_count} player${data.no_shows_count !== 1 ? 's' : ''} signed up but did not participate:
                        </p>
                        <ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
                            ${data.no_shows.map(ns => `
                                <li>${ns.player_name} (Legion ${ns.legion_id})</li>
                            `).join('')}
                        </ul>
                    `;
                }

                container.dataset.loaded = 'true';
            } catch (error) {
                console.error('Failed to load no-shows:', error);
                container.innerHTML = '<p style="color: red; font-style: italic;">Failed to load no-shows data.</p>';
            }
        }

        const allResultsCache = {};

        async function loadAllResults(eventId, legion = null) {
            const cacheKey = `${eventId}_${legion || 'all'}`;

            // Check cache
            if (allResultsCache[cacheKey]) {
                displayAllResults(eventId, allResultsCache[cacheKey]);
                return;
            }

            const container = document.getElementById(`all-results-table-${eventId}`);

            try {
                const url = `/api/events/foundry/${eventId}/results${legion ? `?legion=${legion}` : ''}`;
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load results');
                }

                const data = await response.json();
                allResultsCache[cacheKey] = data;
                displayAllResults(eventId, data);
            } catch (error) {
                console.error('Failed to load all results:', error);
                container.innerHTML = '<p style="color: red; font-style: italic;">Failed to load results data.</p>';
            }
        }

        function displayAllResults(eventId, data) {
            const container = document.getElementById(`all-results-table-${eventId}`);

            if (data.results.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No results found.</p>';
                return;
            }

            container.innerHTML = `
                <p style="margin-bottom: 10px; color: #666;">
                    Showing ${data.total_results} player${data.total_results !== 1 ? 's' : ''}
                </p>
                <table class="scores-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Legion</th>
                            <th>Arsenal Points</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.results.map(r => `
                            <tr>
                                <td>${r.rank || '-'}</td>
                                <td>${r.player_name}</td>
                                <td>Legion ${r.legion_id}</td>
                                <td>${r.score.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function filterResultsByLegion(eventId, legion) {
            const legionValue = legion === '' ? null : parseInt(legion);
            loadAllResults(eventId, legionValue);
        }

        // Add event listeners to details elements after rendering
        function attachNoShowsListeners() {
            document.querySelectorAll('details').forEach(details => {
                details.addEventListener('toggle', function() {
                    if (this.open) {
                        // Check if this is a no-shows details element
                        const noShowsEl = this.querySelector('[id^="no-shows-"]');
                        if (noShowsEl) {
                            const eventId = noShowsEl.id.split('-')[2];
                            loadNoShows(eventId);
                        }

                        // Check if this is an all-results details element
                        const allResultsEl = this.querySelector('[id^="all-results-"]');
                        if (allResultsEl) {
                            const eventId = allResultsEl.id.split('-')[2];
                            loadAllResults(eventId);
                        }
                    }
                });
            });
        }

        document.getElementById('legionFilter').addEventListener('change', renderEvents);
        loadFoundryEvents();
    </script>
</body>
</html>
